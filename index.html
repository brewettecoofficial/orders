/**
 * Brewette ordering flow (static GitHub Pages)
 * - Stepper buttons update quantities
 * - ONE total updates live (totalAmount)
 * - Place Order posts to Apps Script
 */

// ===== CONFIG =====
const UPI_ID = "apoorvak999@oksbi";

const SHEET_WEBHOOK_URL =
  "https://script.google.com/macros/s/AKfycbwjx4taFxEhhBdMwfYdrnCXmi_aL-lONoM_hUtqEnKI8tG9Bbc71eG8uXTnZMmbw0g/exec";

const MAX_QTY = 5;

// Menu
const MENU = {
  coconut_hot:     { name: "Coconut Cloud (Hot)",     price: 350 },
  pourover_hot:    { name: "Hot Pour Over",           price: 325 },
  lavender_tea:    { name: "Lavender Cranberry Tea",  price: 310 },
  caramella_iced:  { name: "Caramella (Iced)",        price: 400 },
  oatmilk_matcha:  { name: "Oatmilk Matcha (Iced)",   price: 415 },
  orange_coldbrew: { name: "Orange Cold Brew",        price: 380 }
};

// State
const order = Object.fromEntries(Object.keys(MENU).map(k => [k, 0]));

// ===== Helpers =====
function formatINR(n) {
  return `₹${n}`;
}

function clampQty(q) {
  return Math.max(0, Math.min(MAX_QTY, q));
}

function computeTotal() {
  return Object.keys(order).reduce(
    (sum, key) => sum + order[key] * MENU[key].price,
    0
  );
}

function render() {
  // Update quantities
  for (const key in order) {
    const qtyEl = document.getElementById(`qty-${key}`);
    if (qtyEl) qtyEl.textContent = order[key];
  }

  // Update ONLY final total
  const totalEl = document.getElementById("totalAmount");
  if (totalEl) totalEl.textContent = formatINR(computeTotal());
}

// ===== Stepper buttons =====
document.addEventListener("click", (e) => {
  const btn = e.target.closest(".stepper-btn");
  if (!btn) return;

  const key = btn.dataset.item;
  const change = Number(btn.dataset.change);

  if (!MENU[key]) return;

  order[key] = clampQty(order[key] + change);
  render();
});

// ===== Copy UPI =====
document.getElementById("copyUpiBtn")?.addEventListener("click", async () => {
  const status = document.getElementById("copyStatus");
  try {
    await navigator.clipboard.writeText(UPI_ID);
    status.textContent = "UPI ID copied.";
    setTimeout(() => (status.textContent = ""), 1500);
  } catch {
    status.textContent = `Copy this UPI ID: ${UPI_ID}`;
  }
});

// ===== Submit order =====
document.getElementById("placeOrderBtn")?.addEventListener("click", submitOrder);

async function submitOrder() {
  const name = document.getElementById("customerName").value.trim();
  const phone = document.getElementById("customerPhone").value.trim();
  const address = document.getElementById("customerAddress").value.trim();

  if (!name || !phone || !address) {
    alert("Please fill in all details.");
    return;
  }

  const items = Object.keys(order)
    .filter(k => order[k] > 0)
    .map(k => ({
      name: MENU[k].name,
      qty: order[k],
      price: MENU[k].price,
      lineTotal: order[k] * MENU[k].price
    }));

  if (items.length === 0) {
    alert("Please select at least one drink.");
    return;
  }

  const payload = {
    customer: { name, phone, address },
    items,
    totalAmount: computeTotal(),
    createdAt: new Date().toISOString()
  };

  const btn = document.getElementById("placeOrderBtn");
  btn.disabled = true;
  btn.textContent = "Placing order...";

  try {
    const res = await fetch(SHEET_WEBHOOK_URL, {
      method: "POST",
      headers: { "Content-Type": "text/plain;charset=utf-8" },
      body: JSON.stringify(payload)
    });

    if (!res.ok) throw new Error("Order failed");

    alert("Order saved! ✅");

    // Reset quantities
    for (const k in order) order[k] = 0;
    render();

  } catch (err) {
    console.error(err);
    alert("Could not save order. Please try again.");
  } finally {
    btn.disabled = false;
    btn.textContent = "Place Order";
  }
}

// Initial render
render();
